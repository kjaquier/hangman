<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns='http://www.w3.org/1999/xhtml'><head><title>Unit 4</title> 
    <meta name='copyright' content='Copyright ⓒ 2013 Cay S. Horstmann'/> 
    <meta content='text/html; charset=UTF-8' http-equiv='content-type'/> 
    <link type='text/css' rel='stylesheet' media='screen, projection, print' href='../../../Slidy2/styles/slidy.css'/> 
    <link type='text/css' rel='stylesheet' media='screen, projection, print' href='../../../MySlidy/style.css'/> 
    <style type='text/css'>div.slide { background-image: url("../../images/sjsu_logo.gif"); background-position: top right; background-repeat: no-repeat; }</style> 
    <script src='../../../Slidy2/scripts/slidy.js' charset='utf-8' type='text/javascript'></script>
    <script src='../../../MySlidy/slidy.js' charset='utf-8' type='text/javascript'></script> </head> 
  <body><h1>Mobile Programming - Unit 4</h1>
    <p class='fullimage'><img src='../../images/tower-hall.jpg' alt='Cover page image'/></p> 
    <p><a href='http://horstmann.com/'>Cay S. Horstmann</a></p>

    <h1>REST</h1>
    <ul><li>Client-server interface</li> 
      <li>Classic model: Remote procedure call (SOAP)</li> 
      <li>REST is stateless, cacheable</li> 
      <li>REST verbs: <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code></li>
      <li>REST API uses <em>resource IDs</em> that are revealed by the application (“hypertext model”)</li>
      <li>REST URLs often look like <code>http://api.fred.com/query/param</code></li>
    </ul>

    <h1>JAX-RS</h1>
    <ul><li>Lets you build REST apps in Java</li>
      <li>Needs a Java app server (e.g. GlassFish) or web profile bits and pieces</li>
      <li>Can convert between Java objects/XML/JSON (via JAXB)</li>
    </ul>

    <h1>Hello, World!</h1>

  <pre>import javax.ws.rs.*;
import javax.ws.rs.core.*;

@Path("/hello")
public class HelloService {
   @GET
   @Path("/{name}")
   public Response getText(@PathParam("name") String name) {
      String output = "Hello " + name + "\n";
      return Response.status(200).entity(output).build();
   }
}
  </pre>
    <h1>Java EE for Elvis</h1>
    <p class='sideimage'><img height='196' width='243' src='elvis-stamp.jpg' alt=''/></p> 
    <ul><li>Standard Java approach for web applications</li> 
      <li>Greatly simplified in EE5, EE6</li> 
      <li>Robust, scalable server technology (transactions, clustering, etc. without additional programming)</li> 
      <li>Why Elvis? Google for <code>Mort Elvis Einstein</code></li> 
    </ul> 

    <h1>Java EE Architecture</h1> 
    <p class='fullimage'><img width='100%' src='ee-app-layers.gif' alt=''/></p> 
    <ul><li>User interface: JSF pages, HTML 5, mobile device</li> 
      <li>Business logic: <em>Session beans</em></li> 
      <li>Persistence: <em>Entity beans</em></li> 
      <li>Bean = class with default constructor and properties (getters/setters)</li> 
    </ul> 

    <h1>Java Persistence Architecture (JPA)</h1> 
    <ul><li>Stores Java <em>entity</em> classes in SQL databases</li> 
      <li>Annotate class with <code>@Entity</code></li>
      <li>Supply ID field and annotate with <code>@Id @GeneratedValue</code></li>
      <li>Annotate relationships with <code>@OneToMany</code> etc. 
        <pre>import javax.persistence.*;
<strong>@Entity</strong> public class Question implements Serializable {
    <strong>@Id @GeneratedValue</strong> private int id;
    private String text;
    <strong>@OneToMany</strong> private Set&lt;Choice&gt; choices;
    <strong>@OneToOne</strong> private Choice answer;
    public Question() {} // No-arg constructor is required          
    ...
}</pre> 
      </li> 
      <li>Stored in a table with columns <code>ID</code>, <code>TEXT</code>, <code>ANSWER_ID</code> </li> 
      <li><code>QUESTION_CHOICE</code> table associates IDs of question and choice</li> 
    </ul> 

    <h1>Entity Manager</h1> 
    <p class='fullimage'><img src='entity-manager.png' alt='???'/></p> 
    <ul><li>Persistence context = set of managed entities</li> 
      <li>Entity manager = object that manages persistence context (has methods <tt>persist</tt>, <tt>find</tt>, <tt>createQuery</tt>, ...) </li> 
      <li>JPQL = object-oriented persistence query language 
        <pre>EntityManager em = ...; // see next slide
Query q = em.createQuery("SELECT x FROM Question q WHERE q.id = :id")
    .setParameter("id", id);
Question p = (Question) q.getSingleResult(); // Also fetches choices (maybe lazily)</pre> 
      </li>
      <li><a href='http://docs.oracle.com/javaee/6/tutorial/doc/bnbtl.html'>Here</a> are more sample JPA queries</li>
    </ul> 

    <h1>Session Beans</h1> 
    <ul><li>Entity manager can only be accessed by “session beans”</li> 
      <li>Stateless session bean has “do and forget” methods; similar to a class with only static methods</li> 
      <li>Methods are automatically transactional (serialized, roll back on errors)</li> 
      <li>Entity manager injected into session bean 
        <pre>@Stateless
public class UserSB {
    <strong>@PersistenceContext</strong> private EntityManager em;
    ...
}</pre> 
      </li> 
      <li>“injected” means that the field is set by the container when the bean is constructed</li> 
    </ul>
      
    
   <h1>Lab</h1> 
    <p class='sideimage'><img src='../../images/lab.jpg'/></p> 
    <ul><li>Bring your laptop to each class</li> 
      <li>You will work with a buddy</li> 
      <li>One of you writes code, the other types up answers</li> 
      <li>Switch roles each lab (not each day)</li> 
      <li>Submit lab work to Piazza</li> 
    </ul>

    <h1>Hello, World</h1>
    <ul><li>Run <code>path/to/glassfish4/bin/asadmin start-domain</code></li>
      <li>Point your web browser to <code>http://localhost:8080</code>. What happens?</li>
      <li>In your work directory for this course, run <code>mkdir -p unit4/WEB-INF/classes</code> (or the Windows equivalent to make these three directories)</li>
      <li>Place the <code>HelloService</code> class into the <code>unit4</code> directory</li>
      <li>Also place the following class there:
        <pre>import java.util.*;
import javax.ws.rs.*;
import javax.ws.rs.core.*;

@ApplicationPath("/rest")
public class AppConfig extends Application {
   public Set&lt;Class&lt;?&gt;&gt; getClasses() {
      return new java.util.HashSet&lt;Class&lt;?&gt;&gt;(Arrays.asList(HelloService.class));
   }
}
        </pre>
    </li>
    <li>Run <code>javac -d WEB-INF/classes -cp .:path/to/glassfish4/glassfish/modules/\* *.java</code>. (Windows users: You need to use <code>;</code> instead of <code>:</code> to separate the paths, and <code>\</code> instead of <code>/</code> for separating directories, but you get to omit the <code>\</code> in front of the <code>*</code> in the second classpath element.)</li>
    <li>Run <code>jar cvfM path/to/glassfish4/glassfish/domains/domain1/autodeploy/myapp.war WEB-INF</code></li>
    <li>Point your browser to <code>http://localhost:8080/myapp/rest/hello/World</code>. What happens?</li>
    <li>Why 8080? Why <code>myapp</code>? Why <code>rest</code>? Why <code>hello</code>?</li>
    <li>What happens with <code>World</code>?</li>    
  </ul>
    <h1>Serving Questions</h1>
    <ul><li>Copy the Question class from Unit 3 to the <code>unit4</code> directory, and remove the package statement.</li>
      <li>Add a <code>QuestionService</code> class
      <pre>import java.util.Scanner;
import javax.ws.rs.*;
import javax.ws.rs.core.*;

@Path("/question")
public class QuestionService {
    @GET
    @Path("/{id}")
    @Produces("text/plain")
    public Response getQuestion(@PathParam("id") int id) {
        // Ignoring id for now
        Question q = new Question();
        q.read(new Scanner("What was the best-selling smartphone OS in 2006?\nAndroid\n*Blackberry\niOS\nWindows Mobile\n"));

        return Response.status(200).entity(q.toString()).build();
    }
}</pre></li>
    <li>Rebuild and point your browser to <code>http://localhost:8080/myapp/rest/question/1</code>. What happens?</li>
      </ul>
    <h1>Optional—Producing XML and JSON</h1>
      <ul><li>The steps on this slide are optional. Skip to the next slide if you don't have time.</li>
    <li>Still here? Add the following highlighted parts to the <code>Question</code> class:
      <pre><strong>import javax.xml.bind.annotation.*; </strong>

<strong>@XmlRootElement</strong>
public class Question implements Serializable {
    <strong>@XmlElement</strong>
    private String text;
    <strong>@XmlElement</strong>
    private List&lt;String&gt; choices = new ArrayList&lt;String&gt;();
    <strong>@XmlElement</strong>
    private String answer;
    ...
}
</pre> </li>
    <li>In <code>QuestionService</code>, change <code>text/plain</code> to <code>application/xml</code> and <code>q.toString()</code> to <code>q</code>. Rebuild and point your browser to <code>http://localhost:8080/myapp/rest/question/1</code>. What happens?</li>
    <li>Now change <code>application/xml</code> to <code>application/json</code> and repeat. What happens?</li>
    <li>Are you impressed?</li>
      </ul>
    <h1>The Entities</h1>
    <ul><li>A quiz has questions. Questions have choices. </li>
      <li><img src='quiz.png'/></li>
      <li>Basic Java classes: <a href='Question.java'><code>Question</code></a> <a href='Choice.java'><code>Choice</code></a>. (We skip <code>Quiz</code> for now)</li>
    <li>Turn these into entity classes. Hint: <code>@Entity</code>, <code>@OneToMany</code>, <code>@OneToOne</code>. Remember to add an <code>id</code> field to each class. Also remember that entity classes need a default constructor.</li>
    </ul>
    <h1>Initializing the Data</h1>
    <ul><li>Normally, this part is done differently. Here, we just do it ad-hoc and in a rather un-RESTful way.</li>
      <li>Start GlassFish and run
      <pre>path/to/glassfish4/bin/asadmin start-database</pre>
        </li>
      <li>Build a WAR file with
      <ul><li><a href='QuestionService.java'><code>QuestionService</code></a>
        <li>Your entity classes</li>
        <li>The <code>AppConfig</code> from the previous step</li>
        <li><a href='persistence.xml'><code>persistence.xml</code></a> in <code>WEB-INF/classes/META-INF/persistence.xml</code></li>
      </li>
      </ul></li>
      <li>After compiling and deploying, point your browser to <code>http://localhost:8080/myapp/rest/question/init</code></li>
      <li>What happens?</li>
      <li>Write down those numbers. You'll need them later.</li>
    </ul>

    <h1>Optional—Spying on the Database</h1>
    <ul><li>This slide is optional. Skip it if you are short on time.</li>
      <li>Make a file <code>ij.properties</code> with this contents:
    <pre>ij.driver=org.apache.derby.jdbc.ClientDriver
ij.protocol=jdbc:derby://localhost:1527/
ij.database=sun-appserv-samples</pre>
        Run the command
      <pre>java -jar path/to/glassfish4/javadb/lib/derbyrun.jar ij -p ij.properties</pre>
        Then run the commands
      <pre>select * from question;
select * from choice;        
select * from question_choice;</pre>
        Explain the role of the <code>question_choice</code> table.
      </li>
      <li><code>exit;</code> gets you out of <code>ij</code>.</li>
    </ul>
    <h1>Client Queries</h1>
    <ul><li>Complete the JAX-RS method that lets us query for a question with a given ID as <code>http://localhost:8080/myapp/rest/question/129</code>, where the last part is the question id, revealed by the <code>/init</code> command. Make a JPQL query and return the <code>toString</code> of the result.</li>
      <li>Compile and deploy, then point your browser to the URL given above, where you use the ID number of the question that you got from two slides ago.</li>
      <li>What happens?</li>
      <li>Optional, if you have extra time: Change your program so that you get the question in JSON format. How did you do that? (Hint: <code>@XmlRootElement</code>, <code>@XmlElement</code>,  <code>@Produces</code>)</li>
    </ul>
    
  </body>
</html>
